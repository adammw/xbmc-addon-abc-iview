#!/usr/bin/env python

# GIT pre-commit hook to write the version number
#
# Set up like this from top dir:
#   ln -s utils/git-hooks/pre-commit .git/hooks/pre-commit
#

import os
import re
import xml.dom.minidom as DOM

VERSION_PY = """# This file is generated by a GIT pre-commit hook
VERSION = '%s'
"""
# This can be changed for testing
ADDON_PATH = '.'

def get_output(cmd):
    pipe = os.popen(cmd, 'r')
    text = pipe.read().rstrip('\n')
    status = pipe.close() or 0
    return status, text


def get_version_git():
    n, result = get_output('git describe --tags')
    if n:
        _print('WARNING: git describe failed with: %s %s' % (n, result))
        return None, None

    match = re.match(r'(?:v)(\d+).(\d+)(?:\.(\d+))?(?:-(\d+-g[0-9a-z]+))?', result, re.VERBOSE)
    if not match:
        return None

    # Remove 'None's from optional regex captures
    numbers = [n for n in match.groups() if n]

    if len(numbers) < 4:
        name = '.'.join(tuple(numbers))
    else:
        # Git version, without offical v1.2 style tag
        name = '%s.%s.%s-%s' % tuple(numbers)

    n, result = get_output('git branch')
    branch = re.search(r'\* (\w+)', result).group(1)
    if branch != 'master' and not re.match('^v\d+$', branch):
        name = branch + '-' + name

    return name


def git_add_file(f):
    n, result = get_output("git add %s" % f)
    if n:
        _print('WARNING: git add failed with: %s %s' % (n, result))
        return False
    return True
 

def write_version(ver):
    version_path = os.path.join(ADDON_PATH, 'resources', 'lib', 'version.py')
    f = open(version_path, "w")
    f.write(VERSION_PY % ver)
    f.close()
    git_add_file(version_path)
   

def write_addon_xml_version(ver):
    addon_xml_file = os.path.join(ADDON_PATH, 'addon.xml')
    dom = DOM.parse(addon_xml_file)
    addon = dom.getElementsByTagName('addon')[0]
    version = addon.setAttribute('version', ver)

    f = open(addon_xml_file, 'w')
    dom.writexml(f)
    f.close()
    git_add_file(addon_xml_file)


if __name__ == '__main__':
    ver = get_version_git()
    if ver:
      write_version(ver)
      write_addon_xml_version(ver)
